<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0d1117">
<title>SV å‹ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:system-ui,-apple-system,sans-serif;
  background:#0d1117;color:#e6edf3;
  min-height:100vh;padding:1rem;line-height:1.5;
}
.container{max-width:500px;margin:0 auto;}
h1{text-align:center;color:#58a6ff;font-size:1.6rem;margin-bottom:1rem;padding-bottom:0.8rem;border-bottom:1px solid #30363d;}

.total-games{text-align:center;font-size:1.4rem;color:#79c0ff;margin:1.5rem 0;}

.login-area{text-align:center;margin:1.5rem 0;}
#login-btn{background:#1DA1F2;color:white;padding:0.9rem 1.5rem;border-radius:8px;font-weight:bold;font-size:1.1rem;}
#logout-btn{background:#666;color:#fff;padding:0.5rem 1rem;border-radius:6px;margin-top:0.5rem;font-size:0.9rem;display:none;}

section{
  background:#161b22;border:1px solid #30363d;
  border-radius:12px;padding:1.2rem;margin-bottom:1.5rem;
}

h2{
  color:#79c0ff;font-size:1.25rem;margin-bottom:1rem;
}

input,select,button{
  width:100%;padding:0.85rem;margin:0.6rem 0;
  border-radius:8px;border:none;font-size:1rem;
}
input,select{
  background:#0d1117;color:#e6edf3;border:1px solid #30363d;
}
button{
  background:#238636;color:white;font-weight:bold;cursor:pointer;
}
button:active{opacity:0.8;}

.row{display:flex;gap:0.8rem;}
.row button{width:auto;flex:1;padding:0.9rem;}

.win-btn{background:#238636;}
.lose-btn{background:#da3633;}
.delete-btn{background:#da3633;padding:0.4rem 0.9rem;font-size:1.3rem;width:auto;margin-left:0.8rem;}

ul{list-style:none;}
li{
  background:#0d1117;padding:0.9rem;margin-bottom:0.6rem;
  border-radius:8px;display:flex;justify-content:space-between;
  align-items:center;border:1px solid #30363d;
}

.class-title{
  color:#58a6ff;font-weight:bold;font-size:1.2rem;margin:1.2rem 0 0.8rem;
}

table{
  width:100%;border-collapse:collapse;margin-top:1rem;
  background:#0d1117;border-radius:8px;overflow:hidden;
}
th,td{padding:0.9rem;text-align:center;border-bottom:1px solid #30363d;}
th{background:#1f6feb;color:white;font-weight:bold;}

.hidden{display:none;}

canvas{max-width:280px;margin:1.5rem auto;display:block;}
</style>
</head>

<body>
<div class="container">
  <h1>Shadowverse å‹ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>

  <div class="login-area">
    <button id="login-btn">Xã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ï¼‰</button>
    <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <p style="margin-top:0.8rem;font-size:0.9rem;color:#888;">ãƒ­ã‚°ã‚¤ãƒ³ã—ãªãã¦ã‚‚ä½¿ãˆã¾ã™</p>
  </div>

  <div class="total-games">ç·å¯¾æˆ¦æ•°: <span id="total-games">0</span> æˆ¦</div>

  <!-- è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­ -->
  <section>
    <h2>è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­ï¼ˆæœ€å¤§10å€‹ï¼‰</h2>
    <div class="row">
      <input type="text" id="mydeck-input" placeholder="ãƒ‡ãƒƒã‚­å" maxlength="20">
      <button id="add-mydeck" style="width:auto;padding:0.85rem 1.2rem;">è¿½åŠ </button>
    </div>
    <ul id="mydeck-list"></ul>
  </section>

  <!-- ç›¸æ‰‹ãƒ‡ãƒƒã‚­ -->
  <section>
    <h2>ç›¸æ‰‹ãƒ‡ãƒƒã‚­ç™»éŒ²ãƒ»ä¸€è¦§</h2>
    <select id="opp-class">
      <option value="">- ã‚¯ãƒ©ã‚¹ã‚’é¸æŠ -</option>
      <option>ã‚¨ãƒ«ãƒ•</option><option>ãƒ­ã‚¤ãƒ¤ãƒ«</option><option>ã‚¦ã‚£ãƒƒãƒ</option>
      <option>ãƒ‰ãƒ©ã‚´ãƒ³</option><option>ãƒŠã‚¤ãƒˆãƒ¡ã‚¢</option><option>ãƒ“ã‚·ãƒ§ãƒƒãƒ—</option><option>ãƒãƒ¡ã‚·ã‚¹</option>
    </select>

    <input type="text" id="opp-name" placeholder="ãƒ‡ãƒƒã‚­åï¼ˆç©ºæ¬„å¯ï¼‰">
    <button id="add-oppdeck">ç™»éŒ²</button>

    <div id="oppdeck-container"></div>
  </section>

  <!-- å¯¾æˆ¦ç™»éŒ² -->
  <section>
    <h2>å¯¾æˆ¦ç™»éŒ²</h2>
    <select id="select-mydeck"><option>è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option></select>
    <select id="select-oppdeck"><option>ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option></select>
    <div class="row"><button class="win-btn">å‹åˆ©</button><button class="lose-btn">æ•—åŒ—</button></div>
  </section>

  <!-- å‹ç‡è¡¨ç¤º -->
  <section>
    <h2>å‹ç‡è©³ç´°</h2>
    <select id="stats-mydeck"><option>ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option></select>

    <div id="overall-stats" class="hidden" style="text-align:center;">
      <h3 id="deck-title" style="color:#79c0ff;"></h3>
      <canvas id="winrate-chart"></canvas>
      <p style="font-size:1.3rem;margin:1rem 0;">
        ç·è©¦åˆæ•°: <span id="total">0</span>ã€€
        å‹åˆ©: <span id="wins">0</span>ã€€
        å‹ç‡: <span id="rate">0</span>%
      </p>
      <button id="show-detail" style="background:#1f6feb;">å¯¾æˆ¦ç›¸æ‰‹åˆ¥è©³ç´°</button>
      <div id="detail-stats"></div>
    </div>
  </section>

</div>

<!-- ã“ã“ã‹ã‚‰JS -->
<script>
// Service Worker ç™»éŒ²
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js");
  });
}

// Firebase åˆæœŸåŒ–
const firebaseConfig = {
  apiKey: "AIzaSyCoghsP1GravcmQ_mwOR5rwp8A2ScHQFF8",
  authDomain: "sv-tracker-f342b.firebaseapp.com",
  projectId: "sv-tracker-f342b",
  storageBucket: "sv-tracker-f342b.firebasestorage.app",
  messagingSenderId: "860547534336",
  appId: "1:860547534336:web:57c05e38dea557f50892e5",
  measurementId: "G-29KV59XLVC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let myDecks=[],oppDecks=[],records=[],userId=null,chart=null;
const classOrder=['ã‚¨ãƒ«ãƒ•','ãƒ­ã‚¤ãƒ¤ãƒ«','ã‚¦ã‚£ãƒƒãƒ','ãƒ‰ãƒ©ã‚´ãƒ³','ãƒŠã‚¤ãƒˆãƒ¡ã‚¢','ãƒ“ã‚·ãƒ§ãƒƒãƒ—','ãƒãƒ¡ã‚·ã‚¹'];

auth.onAuthStateChanged(u=>{
  userId=u?u.uid:null;
  document.getElementById('login-btn').classList.toggle('hidden',!!u);
  document.getElementById('logout-btn').classList.toggle('hidden',!u);
  u?loadFromCloud():loadFromLocal();
  renderAll();
});

document.getElementById('login-btn').onclick=()=>{
  const p=new firebase.auth.TwitterAuthProvider();
  auth.signInWithPopup(p);
};
document.getElementById('logout-btn').onclick=()=>auth.signOut();

// Local / Cloud Save
function saveToLocal(){localStorage.myDecks=JSON.stringify(myDecks);localStorage.oppDecks=JSON.stringify(oppDecks);localStorage.records=JSON.stringify(records);}
function loadFromLocal(){myDecks=JSON.parse(localStorage.myDecks||'[]');oppDecks=JSON.parse(localStorage.oppDecks||'[]');records=JSON.parse(localStorage.records||'[]');}
function saveToCloud(){if(!userId)return saveToLocal();db.collection('users').doc(userId).set({myDecks,oppDecks,records,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});}
function loadFromCloud(){if(!userId)return;db.collection('users').doc(userId).onSnapshot(d=>{if(d.exists){const o=d.data();myDecks=o.myDecks||[];oppDecks=o.oppDecks||[];records=o.records||[];renderAll();}},()=>loadFromLocal());}

function saveAll(){saveToCloud();saveToLocal();}

// ğŸŸ¦ è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­è¡¨ç¤º
function renderMyDecks(){
  const ul=document.getElementById('mydeck-list');
  ul.innerHTML='';
  myDecks.forEach(d=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${d}</span>`;
    const b=document.createElement('button');
    b.textContent='Ã—';
    b.className='delete-btn';
    b.onclick=()=>{
      if(confirm(d+'å‰Šé™¤ï¼Ÿ')){
        myDecks=myDecks.filter(x=>x!==d);
        records=records.filter(r=>r.myDeck!==d);
        saveAll();renderMyDecks();renderSelects();renderStatsSelect();
      }
    };
    li.appendChild(b);
    ul.appendChild(li);
  });
}

// ğŸŸ¦ ç›¸æ‰‹ãƒ‡ãƒƒã‚­ä¸€è¦§
function renderOppDecks(){
  const c=document.getElementById('oppdeck-container');
  c.innerHTML='';
  classOrder.forEach(cl=>{
    const list=oppDecks.filter(x=>x.startsWith(cl+'::'));
    if(!list.length)return;
    const div=document.createElement('div');
    div.innerHTML=`<div class="class-title">${cl}</div><ul></ul>`;
    const ul=div.querySelector('ul');
    list.forEach(k=>{
      const [_,n]=k.split('::');
      const li=document.createElement('li');
      li.innerHTML=`<span>${n} <small>(${cl})</small></span>`;
      const b=document.createElement('button');
      b.textContent='Ã—';
      b.className='delete-btn';
      b.onclick=()=>{
        oppDecks=oppDecks.filter(x=>x!==k);
        records=records.filter(r=>r.oppDeck!==k);
        saveAll();renderOppDecks();renderSelects();
      };
      li.appendChild(b);
      ul.appendChild(li);
    });
    c.appendChild(div);
  });
}

// ğŸŸ¦ ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
function renderSelects(){
  const m=document.getElementById('select-mydeck');
  const o=document.getElementById('select-oppdeck');
  m.innerHTML='<option>è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option>';
  o.innerHTML='<option>ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option>';
  myDecks.forEach(d=>m.add(new Option(d,d)));
  oppDecks.forEach(k=>{
    const [c,n]=k.split('::');
    o.add(new Option(`${n} (${c})`,k));
  });
}

// ğŸŸ¦ å‹æ•—è¨˜éŒ²
document.querySelector('.win-btn').onclick=()=>record(true);
document.querySelector('.lose-btn').onclick=()=>record(false);

function record(w){
  const m=document.getElementById('select-mydeck').value;
  const o=document.getElementById('select-oppdeck').value;
  if(!m||!o)return alert('ä¸¡æ–¹é¸æŠã—ã¦');
  records.push({myDeck:m,oppDeck:o,win:w,date:Date.now()});
  saveAll();document.getElementById('select-oppdeck').value='';
  renderSelects();
  alert('ç™»éŒ²ã—ã¾ã—ãŸ');
}

// ğŸŸ¦ å‹ç‡è©³ç´°
function renderStatsSelect(){
  const s=document.getElementById('stats-mydeck');
  s.innerHTML='<option>ãƒ‡ãƒƒã‚­ã‚’é¸æŠ</option>';
  myDecks.forEach(d=>s.add(new Option(d,d)));
}

document.getElementById('stats-mydeck').onchange=e=>{
  const d=e.target.value;
  const box=document.getElementById('overall-stats');
  if(!d){box.classList.add('hidden');return;}
  const r=records.filter(x=>x.myDeck===d);
  const w=r.filter(x=>x.win).length;
  const t=r.length;
  const rate=t?Math.round(w/t*1000)/10:0;
  document.getElementById('deck-title').textContent=d;
  document.getElementById('total').textContent=t;
  document.getElementById('wins').textContent=w;
  document.getElementById('rate').textContent=rate;
  box.classList.remove('hidden');
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById('winrate-chart'),{
    type:'doughnut',
    data:{labels:['å‹åˆ©','æ•—åŒ—'],datasets:[{data:[w,t-w],backgroundColor:['#238636','#da3633'],borderWidth:0}]},
    options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#e6edf3'}}}}
  });
};

// ğŸŸ¦ ç›¸æ‰‹åˆ¥è©³ç´°
document.getElementById('show-detail').onclick=()=>{
  const d=document.getElementById('stats-mydeck').value;
  const div=document.getElementById('detail-stats');
  const map={};
  records.filter(r=>r.myDeck===d).forEach(r=>{
    map[r.oppDeck]=(map[r.oppDeck]||{win:0,total:0});
    map[r.oppDeck].total++;
    if(r.win)map[r.oppDeck].win++;
  });
  let h='<table><tr><th>ç›¸æ‰‹</th><th>å¯¾æˆ¦</th><th>å‹</th><th>å‹ç‡</th></tr>';
  Object.keys(map).sort((a,b)=>map[b].total-map[a].total).forEach(k=>{
    const [c,n]=k.split('::');
    const o=map[k];
    const r=Math.round(o.win/o.total*1000)/10;
    h+=`<tr><td>${n} (${c})</td><td>${o.total}</td><td>${o.win}</td><td>${r}%</td></tr>`;
  });
  div.innerHTML=h+'</table>';
  div.classList.toggle('hidden');
};

// åˆæœŸãƒ­ãƒ¼ãƒ‰
function renderAll(){
  renderMyDecks();
  renderOppDecks();
  renderSelects();
  renderStatsSelect();
  document.getElementById('total-games').textContent=records.length;
}

loadFromLocal();
renderAll();

</script>

</body>
</html>
